var contentImport={},g=$G;function upload(e){var t=new XMLHttpRequest,n=new FormData,r=editor.getOpt("imageUrlPrefix"),o=editor.getActionUrl(editor.getOpt("imageActionName")),i="png";if(e.type&&(i=e.type.substr("image/".length)),n.append("upfile",e,e.name||"blob."+i),n.append("type","ajax"),t.open("post",o,!1),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.send(n),200==t.status){t=new Function("return "+t.responseText)();return"SUCCESS"==t.state&&t.url?r+t.url:e}}function processWord(e){$(".file-tip").html("正在转换Word文件，请稍后..."),$(".file-result").html("").hide();var t=new FileReader;t.onload=function(e){mammoth.convertToHtml({arrayBuffer:e.target.result},{convertImage:mammoth.images.imgElement(function(t){return t.readAsArrayBuffer().then(function(e){return{src:upload(new Blob([e],{type:t.contentType})),alt:"文档图片"}})})}).then(function(e){$(".file-tip").html("转换成功"),contentImport.data.result=e.value,$(".file-result").html(e.value).show()},function(e){$(".file-tip").html("Word文件转换失败:"+e)})},t.onerror=function(e){$(".file-tip").html("Word文件转换失败:"+e)},t.readAsArrayBuffer(e)}function processMarkdown(e){e=(new showdown.Converter).makeHtml(e);$(".file-tip").html("转换成功"),contentImport.data.result=e,$(".file-result").html(e).show()}function processMarkdownFile(e){$(".file-tip").html("正在转换Markdown文件，请稍后..."),$(".file-result").html("").hide();var t=new FileReader;t.onload=function(e){processMarkdown(e.target.result)},t.onerror=function(e){$(".file-tip").html("Markdown文件转换失败:"+e)},t.readAsText(e,"UTF-8")}function addUploadButtonListener(){g("contentImport").addEventListener("change",function(){var e=this.files[0];const t=e.name;var n=t.substring(t.lastIndexOf(".")+1).toLowerCase();switch(n){case"docx":case"doc":processWord(e);break;case"md":processMarkdownFile(e);break;default:$(".file-tip").html("不支持的文件格式:"+n)}}),g("fileInputConfirm").addEventListener("click",function(){processMarkdown(g("fileInputContent").value),$(".file-input").hide()})}function addOkListener(){dialog.onok=function(){if(!contentImport.data.result)return alert("请先上传文件识别内容"),!1;editor.fireEvent("saveScene"),editor.execCommand("inserthtml",contentImport.data.result),editor.fireEvent("saveScene")},dialog.oncancel=function(){}}contentImport.data={result:null},contentImport.init=function(e,t){addUploadButtonListener(),addOkListener()};