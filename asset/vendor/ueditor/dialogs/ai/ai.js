"use strict";function _createForOfIteratorHelper(t,e){var o="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!o){if(Array.isArray(t)||(o=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){o&&(t=o);var n=0,e=function(){};return{s:e,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,r=!0,a=!1;return{s:function(){o=o.call(t)},n:function(){var t=o.next();return r=t.done,t},e:function(t){a=!0,i=t},f:function(){try{r||null==o.return||o.return()}finally{if(a)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var o={}.toString.call(t).slice(8,-1);return"Map"===(o="Object"===o&&t.constructor?t.constructor.name:o)||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var o=0,n=Array(e);o<e;o++)n[o]=t[o];return n}var aiConfig=editor.getOpt("ai"),aiFunctions=editor.getOpt("aiFunctions"),isMultiLine=function(t){return-1!==t.indexOf("\n")},fetchStream=function(t,e,u,p){fetch(t,Object.assign({method:"POST"},e)).then(function(t){var e,s,c,l;function n(t){var e,t=(c+=s.decode(t,{stream:!0})).split("\n"),o=_createForOfIteratorHelper(t);try{for(o.s();!(e=o.n()).done;){var n=e.value;if((n=n.trim()).startsWith("data:")){var i=n.replace("data:","").trim();if("[DONE]"===i)return void p({code:0,msg:"ok",data:{text:l.join("")}});try{var r=null,a=JSON.parse(i);if(a.choices&&0<a.choices.length&&a.choices[0].delta)r=a.choices[0].delta.content;else if(a.type){if("error"===a.type)return void p({code:-1,msg:a.data});if("end"===a.type)return void p({code:0,msg:"ok",data:{text:l.join("")}});"data"===a.type&&(r=a.data)}null!==r?(l.push(r),u({code:0,msg:"ok",data:{text:r}})):(p({code:-1,msg:"No text found!"}),console.log("data:",a))}catch(t){p({code:-1,msg:"JSON parse error!"+t})}}}}catch(t){o.e(t)}finally{o.f()}c=t.pop()||""}t.ok?(e=t.body.getReader(),s=new TextDecoder("utf-8"),c="",l=[],function o(){e.read().then(function(t){var e=t.done,t=t.value;e?c&&n(new Uint8Array):(n(t),o())}).catch(function(t){p({code:-1,msg:"Stream error!"+t})})}()):p({code:-1,msg:"HTTP error! status: ".concat(t.status)})}).catch(function(t){p({code:-1,msg:"Request error!"+t})})},openAiCompletion=function(t,e,o){(o=Object.assign({body:null},o)).body||(o.body={model:aiConfig.driverConfig.model,messages:[{role:"system",content:e.systemPromptText},{role:"user",content:e.promptText}],stream:!0}),fetchStream(t,{headers:{Authorization:"Bearer ".concat(aiConfig.driverConfig.key),"Content-Type":"application/json"},body:JSON.stringify(o.body)},e.onStream,e.onFinish)},drivers={ModStart:function(t){openAiCompletion(aiConfig.driverConfig.url,t,{body:{systemPrompt:t.systemPromptText,prompt:t.promptText}})},OpenAi:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.openai.com/v1/chat/completions",t)},DeepSeek:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.deepseek.com/v1/chat/completions",t)},Anthropic:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.anthropic.com/v1/messages",t)},Google:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",t)},Baidu:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/completions",t)},Alibaba:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",t)},Tencent:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://hunyuan.tencentcloudapi.com/v1/chat/completions",t)},Huawei:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://pangu.huaweicloud.com/v1/chat/completions",t)},ByteDance:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://ark.cn-beijing.volces.com/api/v3/chat/completions",t)},Zhipu:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://open.bigmodel.cn/api/paas/v4/chat/completions",t)},Moonshot:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.moonshot.cn/v1/chat/completions",t)},iFlytek:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://spark-api-open.xf-yun.com/v1/chat/completions",t)},Volcengine:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://ark.cn-beijing.volces.com/api/v3/chat/completions",t)}};function getRequest(t){return aiConfig.driverRequest||(t in drivers?drivers[t]:null)}var converter=new window.showdown.Converter,AiDefaultAiFunctionParam={showInsert:!0,showReplace:!0,showReplaceAll:!1},Ai={runtime:{range:null},init:function(){new Vue({el:"#app",data:{loading:!1,selectText:"",inputText:"",submitFunction:null,systemPromptText:"",promptText:"",resultText:"",resultError:"",functions:[],showInsert:AiDefaultAiFunctionParam.showInsert,showReplace:AiDefaultAiFunctionParam.showReplace,showReplaceAll:AiDefaultAiFunctionParam.showReplaceAll},mounted:function(){Ai.runtime.range=editor.selection.getRange();var t=Ai.runtime.range.cloneContents();this.selectText=t?t.textContent.trim():"",this.buildFunctions()},computed:{resultHtml:function(){return this.resultText?converter.makeHtml(this.resultText):""},resultHeight:function(){var t=255;return this.selectText&&(t-=45),this.resultError&&(t-=45),t+"px"}},methods:{buildFunctions:function(){var e={selectText:this.selectText};this.functions=aiFunctions.map(function(t){return t.enable(e)?(t.prompt=t.prompt.replace(/\{selectText\}/g,e.selectText),t.prompt=t.prompt.replace(/\{html\}/g,editor.getContent()),t.param=Object.assign({},AiDefaultAiFunctionParam,t.param),t):null}).filter(function(t){return!!t})},doSubmit:function(){var t,e=this;this.loading||(this.systemPromptText?(this.loading=!0,this.resultError="",this.resultText="",(t=getRequest(aiConfig.driver))?t({systemPromptText:this.systemPromptText,promptText:this.promptText,onStream:function(t){t.code?e.resultError=t.msg:e.resultText+=t.data.text},onFinish:function(t){e.loading=!1,t.code?e.resultError=t.msg:e.resultText=t.data.text}}):editor.tipError("未找到驱动")):editor.tipError("请输入系统提示语"))},doSubmitFunction:function(t){this.submitFunction=t,this.systemPromptText=t.systemPrompt||"",this.promptText=t.prompt||"",this.showInsert=t.param.showInsert,this.showReplace=t.param.showReplace,this.showReplaceAll=t.param.showReplaceAll,this.doSubmit()},doSubmitDirect:function(){this.submitFunction=null,this.systemPromptText=this.inputText||"",this.systemPromptText?(this.showInsert=AiDefaultAiFunctionParam.showInsert,this.showReplace=AiDefaultAiFunctionParam.showReplace,this.showReplaceAll=AiDefaultAiFunctionParam.showReplaceAll,this.doSubmit()):editor.tipError("请输入系统提示语")},doInsert:function(){editor.fireEvent("saveScene"),this.selectText?isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)):isMultiLine(this.resultText)?editor.execCommand("insertHtml",this.resultHtml):editor.execCommand("insertHtml",this.resultText),dialog.close(!0)},doReplace:function(){editor.fireEvent("saveScene"),Ai.runtime.range.deleteContents(),isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)),dialog.close(!0)},doReplaceAll:function(){editor.fireEvent("saveScene"),editor.setContent(this.resultText),dialog.close(!0)}}})}};utils.domReady(function(){Ai.init()});