"use strict";function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,e=function(){};return{s:e,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r={}.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}var aiConfig=editor.getOpt("ai"),aiFunctions=editor.getOpt("aiFunctions"),isMultiLine=function(t){return-1!==t.indexOf("\n")},fetchStream=function(t,e,l,d){fetch(t,Object.assign({method:"POST"},e)).then(function(t){var e,s,u,c;function n(t){var e,t=(u+=s.decode(t,{stream:!0})).split("\n"),r=_createForOfIteratorHelper(t);try{for(r.s();!(e=r.n()).done;){var n=e.value;if((n=n.trim()).startsWith("data:")){var i=n.replace("data:","").trim();if("[DONE]"===i)return void d({code:0,msg:"ok",data:{text:c.join("")}});try{var o=null,a=JSON.parse(i);if(a.choices&&0<a.choices.length&&a.choices[0].delta)o=a.choices[0].delta.content;else if(a.type){if("error"===a.type)return void d({code:-1,msg:a.data});if("end"===a.type)return void d({code:0,msg:"ok",data:{text:c.join("")}});"data"===a.type&&(o=a.data)}null!==o?(c.push(o),l({code:0,msg:"ok",data:{text:o}})):(d({code:-1,msg:"No text found!"}),console.log("data:",a))}catch(t){d({code:-1,msg:"JSON parse error!"+t})}}}}catch(t){r.e(t)}finally{r.f()}u=t.pop()||""}t.ok?(e=t.body.getReader(),s=new TextDecoder("utf-8"),u="",c=[],function r(){e.read().then(function(t){var e=t.done,t=t.value;e?u&&n(new Uint8Array):(n(t),r())}).catch(function(t){d({code:-1,msg:"Stream error!"+t})})}()):d({code:-1,msg:"HTTP error! status: ".concat(t.status)})}).catch(function(t){d({code:-1,msg:"Request error!"+t})})},openAiCompletion=function(t,e,r){(r=Object.assign({body:null},r)).body||(r.body={model:aiConfig.driverConfig.model,messages:[{role:"user",content:e.promptText}],stream:!0}),fetchStream(t,{headers:{Authorization:"Bearer ".concat(aiConfig.driverConfig.key),"Content-Type":"application/json"},body:JSON.stringify(r.body)},e.onStream,e.onFinish)},drivers={ModStart:function(t){openAiCompletion(aiConfig.driverConfig.url,t,{body:{prompt:t.promptText}})},OpenAi:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.openai.com/v1/engines/davinci/completions",t)},DeepSeek:function(t){openAiCompletion(aiConfig.driverConfig.url||"https://api.deepseek.com/chat/completions",t)}};function getRequest(t){return aiConfig.driverRequest||(t in drivers?drivers[t]:null)}var converter=new window.showdown.Converter,Ai={runtime:{range:null},init:function(){new Vue({el:"#app",data:{loading:!1,selectText:"",inputText:"",promptText:"",resultText:"",resultError:"",functions:[]},mounted:function(){Ai.runtime.range=editor.selection.getRange();var t=Ai.runtime.range.cloneContents();this.selectText=t?t.textContent.trim():"",this.buildFunctions()},computed:{resultHtml:function(){return this.resultText?converter.makeHtml(this.resultText):""},resultHeight:function(){var t=255;return this.selectText&&(t-=45),this.resultError&&(t-=45),t+"px"}},methods:{buildFunctions:function(){var e={selectText:this.selectText};this.functions=aiFunctions.map(function(t){return t.enable(e)?(t.prompt=t.prompt.replace(/\{selectText\}/g,e.selectText),t):null}).filter(function(t){return!!t})},doSubmit:function(){var t,e=this;this.loading||(this.inputText&&(this.selectText?this.promptText=this.selectText+"\n\n"+this.inputText:this.promptText=this.inputText),this.promptText?(this.loading=!0,this.resultError="",this.resultText="",(t=getRequest(aiConfig.driver))?t({promptText:this.promptText,onStream:function(t){t.code?e.resultError=t.msg:e.resultText+=t.data.text},onFinish:function(t){e.loading=!1,t.code?e.resultError=t.msg:e.resultText=t.data.text}}):editor.tipError("未找到驱动")):editor.tipError("请输入内容"))},doSubmitFunction:function(t){this.promptText=t.prompt,this.doSubmit()},doInsert:function(){editor.fireEvent("saveScene"),this.selectText?isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)):isMultiLine(this.resultText)?editor.execCommand("insertHtml",this.resultHtml):editor.execCommand("insertHtml",this.resultText),dialog.close(!0)},doReplace:function(){editor.fireEvent("saveScene"),Ai.runtime.range.deleteContents(),isMultiLine(this.resultText)?Ai.runtime.range.insertNode(document.createRange().createContextualFragment(this.resultHtml)):Ai.runtime.range.insertNode(document.createTextNode(this.resultText)),dialog.close(!0)}}})}};utils.domReady(function(){Ai.init()});